(()=>{"use strict";var e=function(e,t,n=null,r=null,a=!0){const o={method:e};let l={};return a&&(l.Authorization="Bearer "+localStorage.getItem("access_token")),n?(o.body=JSON.stringify(n),l["Content-Type"]="application/json"):r&&(o.body=r),o.headers=new Headers(l),fetch(t,o)},t=function(){let t=API_URL;return{getProjects:function(n,r,a,o){return e("GET",`${t}/projects/?skip=${n}&limit=${r}&orderby=${a}&orderdir=${o}`,null,null,!0)},getProject:function(n){return e("GET",`${t}/project/${n}`,null,null,!0)},deleteProject:function(n){return e("DELETE",`${t}/project/${n}`,null,null,!0)},createProject:function(n){return e("POST",`${t}/projects/`,n,null,!0)},updateProject:function(n,r){return e("PUT",`${t}/project/${n}`,r,null,!0)},getAnnotationIds:function(){return e("GET",`${t}/annotation_ids/`,null,null,!0)},exportProject:function(n){return e("GET",`${t}/export/${n}`,null,null,!0)},importProject:function(n){return e("POST",`${t}/import/`,null,n,!0)},getImages:function(n){return e("GET",`${t}/project/${n}/images/`,null,null,!0)},getImageFile:function(n){return e("GET",`${t}/image_file/${n}`,null,null,!0)},createImages:function(n,r){return e("POST",`${t}/project/${n}/images/`,null,r,!0)},deleteImage:function(n){return e("DELETE",`${t}/image/${n}`,null,null,!0)},getAnnotation:function(n){return e("GET",`${t}/annotation/${n}`,null,null,!0)},updateAnnotation:function(n,r){return e("PUT",`${t}/annotation/${n}`,r,null,!0)},createUser:function(n){return e("POST",`${t}/users/`,n,null,!1)},loginUser:function(n){return e("POST",`${t}/token`,null,n,!1)},isValid:function(n){return e("GET",`${t}/isvalid/${n}`,null,null,!1)}}}();async function n(e){var n=await t.getImageFile(e);if(200==n.status){const e=await n.blob();return URL.createObjectURL(e)}if(401!=n.status)throw new Error(`Failed to get image file with id ${e}`);o()}async function r(e){var n=await t.exportProject(e);if(200==n.status){var r=n.headers.get("Content-Disposition").split(/;(.+)/)[1].split(/=(.+)/)[1];r=r.toLowerCase().startsWith("utf-8''")?decodeURIComponent(r.replace("utf-8''","")):r.replace(/['"]/g,"");const e=await n.blob();var a=document.createElement("a");a.href=URL.createObjectURL(e),a.download=r,document.body.appendChild(a),a.click(),a.remove()}else{if(401!=n.status)throw new Error(`Failed to export project with id ${e}`);o()}}async function a(e){const t=FRONTEND_URLS.getEditProjectUrl+"?project_id="+e,n={method:"GET",headers:new Headers({Authorization:"Bearer "+localStorage.getItem("access_token")})};let r=await fetch(t,n);if(200==r.status){const e=await r.json();window.location.href=e.url}else{if(401!=r.status)throw new Error(`Failed to get url for setting up project with id ${e}`);o()}}function o(){window.location.href=FRONTEND_URLS.login}function l(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))}const i="Annotation saved.",s="Failed to save annotation.",c=new mdc.list.MDCList(document.getElementById("images-selection-list"));c.singleSelection=!0;const u=new mdc.snackbar.MDCSnackbar(document.querySelector(".mdc-snackbar"));!async function(e){await async function(){const e=localStorage.getItem("access_token");if(!e)return!1;var n=await t.isValid(e);if(200==n.status)return(await n.json()).isvalid;throw new Error("Failed to determine whether user is logged in")}()?e():o()}((()=>{!async function(e){var d,f,g,p,y,m={id:null,name:null},h=!1,v=[],x="auxline",w=[],_=[],b=[],k=[],j=[],E=[],$="",L=[],I=[];function S(e,t){document.getElementById(`images-selection-list-${e}`).querySelector(".menu-icon").style.visibility=t?"visible":"hidden"}function P(){h&&(null!=m.name&&(I.length>0||L.length>0||_.length>0||b.length>0)&&(async function(e){var n={data:{image:m.name,grid_cells:I,corners:L,auxlines:_,auxcurves:b,prev_intersections:w}};await async function(e,n){var r=await t.updateAnnotation(e,n);if(200==r.status)console.log(i),u.labelText=i,u.open();else{if(401!=r.status)throw console.log(s),u.labelText=s,u.open(),new Error("Failed to save annotation");o()}}(e,n)}(m.id),S(m.id,!0)),h=!1)}function T(){k=[],j=[],E=[]}document.getElementById("export-project-button").addEventListener("click",r.bind(null,e)),document.getElementById("setup-project-button").addEventListener("click",a.bind(null,e)),v=await async function(){var e=await t.getAnnotationIds();if(200==e.status)return await e.json();if(401!=e.status)throw new Error("Failed to get annotation ids");o()}(),async function(e){var n=await t.getImages(e);if(200==n.status)(await n.json()).foreach((function(e){!function(e){const t=`\n          <li id="images-selection-list-${e.id}" data-image-id="${e.id}" data-image-name="${e.name}" class="mdc-deprecated-list-item" role="option">\n            <span class="mdc-deprecated-list-item__ripple"></span>\n            <span class="mdc-deprecated-list-item__text">${(n=e.name,n.split(".").slice(0,-1).join(".")).slice(0,8)}</span>\n            <span class="mdc-deprecated-list-item__meta">\n              <i class="material-icons menu-icon" style="color:green; visibility: hidden;">check</i>\n            </span>\n          </li>`;var n;var r,a;document.getElementById("images-selection-list").appendChild((r=t,(a=document.createElement("template")).innerHTML=r,a.content))}(e);const t=v.includes(e.id);S(e.id,t)}));else{if(401!=n.status)throw new Error("Failed to get images");o()}}(e),window.addEventListener("beforeunload",(e=>{e.preventDefault(),P(),console.log("Saved annotation before reload.")}));var A=function(e){for(var t=e.querySelectorAll("button"),n=0;n<t.length;n++)t[n].classList.remove("btn-active")};function D(){h=!0}document.getElementById("images-selection-list").addEventListener("MDCList:selectionChange",(function(e){P(),N.selectAll("*").remove(),T(),_=[],b=[],w=[],L=[],I=[],x="auxline",$="",A(U),document.getElementById("btn-draw-auxline").classList.add("btn-active");var r=N.append("g").attr("id","g_element"),a=N.select("#g_element").append("image");const l=c.selectedIndex,i=(m={id:e.target.children[l].dataset.imageId,name:e.target.children[l].dataset.imageName}).id;n(i).then((e=>{a.attr("href",e)}));var s=d3.zoom().on("zoom",(function(){r.attr("transform",d3.event.transform)}));s(N);var u=new Image;u.onload=function(){d=u.width,f=u.height,console.log("Changed image:",u.width,u.height);var e=Number(N.style("width").replace("px","")),t=Number(N.style("height").replace("px","")),n=e/2-d/2,r=t/2-f/2,a=d3.zoomIdentity.translate(n,r);N.call(s.transform,a)},n(i).then((e=>{u.src=e}));for(var g=0;g<4;g++)N.select("#g_element").append("line").attr("id","center-line-"+[g]).style("stroke","magenta").style("stroke-dasharray","2, 2").style("stroke-width",.5).style("stroke-opacity",0);N.select("#g_element").append("g").append("circle").attr("id","cursor").attr("r",2).style("fill","magenta").style("opacity",0).style("fill-opacity",1).style("stroke",null),N.select("#g_element").append("g").attr("id","g_auxobjects"),N.select("#g_element").append("g").attr("id","g_pv_modules"),N.select("#g_element").append("g").attr("id","g_corners"),null!==m.id&&async function(e){var n=await t.getAnnotation(e);if(200==n.status){const e=await n.json();"data"in e&&["corners","grid_cells","auxlines","auxcurves","prev_intersections"].every((t=>Object.keys(e.data).includes(t)))&&(L=e.data.corners,I=e.data.grid_cells,_=e.data.auxlines,b=e.data.auxcurves,w=e.data.prev_intersections,J())}else{if(401!=n.status)throw new Error(`Failed to get annotation for image with id ${e}`);o()}}(m.id)}));var N=d3.select("svg");N.on("mousemove",(function(){var e=d3.mouse(this);if(!d3.select("#g_element").empty()){var[t,n,r]=function(e){var t=e.transform.baseVal.consolidate().matrix;return[t.e,t.f,t.d]}(g_element);g=(e[0]-t)/r,p=(e[1]-n)/r,N.select("#cursor").attr("cx",g).attr("cy",p);for(var a=0;a<4;a++)N.select("#center-line-"+[a]).style("stroke-opacity",0);if(L.length>0&&"center"==x)for(y=function(e,t,n){for(var r=[],a=0;a<t.length;a++){var o=Math.pow(t[a].x-e.x,2)+Math.pow(t[a].y-e.y,2);r.push({dist:o,corner:t[a]})}return r.sort((function(e,t){return e.dist>t.dist?1:-1})).slice(0,n)}({x:g,y:p},L,4),a=0;a<y.length;a++)N.select("#center-line-"+[a]).attr("x1",g).attr("y1",p).attr("x2",y[a].corner.x).attr("y2",y[a].corner.y).style("stroke-opacity",1)}})),N.on("mouseover",(function(){if(N.select("#cursor").style("opacity",1),"center"==x)for(var e=0;e<4;e++)N.select("#center-line-"+[e]).style("stroke-opacity",1)})),N.on("mouseout",(function(){if(N.select("#cursor").style("opacity",0),"center"==x)for(var e=0;e<4;e++)N.select("#center-line-"+[e]).style("stroke-opacity",0)}));var U=document.getElementById("drawing-actions");U.addEventListener("click",(function(e){A(U),T(),$="",J();var t=e.target;"btn-add-corner"==t.id?(x="corner",t.classList.add("btn-active"),N.select("#cursor").style("fill","magenta").style("fill-opacity",1).style("stroke",null),console.log("Switched to corner mode")):"btn-create-module"==t.id?(x="center",t.classList.add("btn-active"),N.select("#cursor").style("fill","black").style("fill-opacity",1).style("stroke",null),console.log("Switched to center mode")):"btn-create-module-manual"==t.id?(x="center_manual",t.classList.add("btn-active"),N.select("#cursor").style("fill-opacity",0).style("stroke",null),console.log("Switched to center mode (manual)")):"btn-erase"==t.id?(x="erase",t.classList.add("btn-active"),N.select("#cursor").style("fill",null).style("fill-opacity",0).style("stroke","red").style("stroke-width",.5),console.log("Switched to erase mode")):"btn-draw-auxline"==t.id?(x="auxline",t.classList.add("btn-active"),N.select("#cursor").style("fill","magenta").style("fill-opacity",1).style("stroke",null),console.log("Switched to auxline mode")):"btn-draw-auxcurve"==t.id?(x="auxcurve",t.classList.add("btn-active"),N.select("#cursor").style("fill","magenta").style("fill-opacity",1).style("stroke",null),console.log("Switched to auxcurve mode")):"btn-get-intersects"==t.id?(x=null,N.select("#cursor").style("fill-opacity",0).style("stroke",null),function(){function e(e,t){function n(e){return e.filter(((t,n)=>e.indexOf(t)===n))}var r=[],a=Intersection.intersectShapes(e,t);for(s in a.points)"Vector2D"!=a.points[s].constructor.name&&"Point2D"!=a.points[s].constructor.name||r.push({x:a.points[s].x,y:a.points[s].y});return void 0!==r?n(r):[]}function t(e,t){for(var n=[],r=[],a=[],o=0;o<t.length;o++)e.some((function(e){return e.x==t[o].x&&e.y==t[o].y}))?a.push(t[o]):n.push(t[o]);for(o=0;o<e.length;o++)t.some((function(t){return t.x==e[o].x&&t.y==e[o].y}))||r.push(e[o]);return[n,r,a]}for(var n=[],r=0;r<_.length+b.length;r++)for(var a=r+1;a<_.length+b.length;a++){for(var o=[N.selectAll(".auxobj").nodes()[r],N.selectAll(".auxobj").nodes()[a]],i=[],s=0;s<2;s++)o[s].classList.contains("auxline")?i.push(new Line(o[s])):o[s].classList.contains("auxcurve")&&i.push(new Path(o[s]));var c=e(i[0],i[1]);n.push(...c)}var[u,d,f]=t(w,n);for(w=[...n],s=0;s<u.length;s++)L.push({x:u[s].x,y:u[s].y,id:l()});for(r=L.length-1;r>=0;r--)if(d.some((function(e){return e.x==L[r].x&&e.y==L[r].y}))){var g=[];for(s=0;s<I.length;s++)for(var p=0;p<I[s].corners.length;p++)I[s].corners[p].id==L[r].id&&g.push(s);for(s=g.length-1;s>=0;s--)console.log("Deleting grid cell "+I[s].id+"(it contained deleted point "+L[r].id+")"),I.splice(g[s],1);L.splice(r,1)}}(),D(),J(),console.log("Computed new corners as intersections of auxiliary lines.")):"btn-mark-module-partially-visible"==t.id&&(x="mark_module_partially_visible",t.classList.add("btn-active"),N.select("#cursor").style("fill-opacity",0).style("stroke",null))}),!1),N.on("click",(function(){if("corner"==x)L.push({x:g,y:p,id:l()}),console.log("Placed a new corner marker at (",g,",",p,")"),D(),J();else if("center"==x)if(L.length<4)alert("Before you can create a grid cell you need to place at least four corner markers first.");else{for(var e=[],t=0;t<y.length;t++)e.push(y[t].corner);e=C(e);var n=F(e);I.push({corners:e,center:n,id:l(),truncated:!1}),console.log("Placed a new grid cell at (",n.x,",",n.y,")"),D(),J()}else"auxline"==x?(k.push({x:g,y:p}),2==k.length&&(_.push({x1:k[0].x,y1:k[0].y,x2:k[1].x,y2:k[1].y,id:l()}),console.log("Placed auxiliary line from (",k[0].x,",",k[0].y,") to (",k[1].x,",",k[1].y,")"),k=[],D(),J())):"auxcurve"==x&&(j.push([g,p]),3==j.length&&(b.push({points:j,id:l()}),j=[],console.log("Placed auxiliary curve"),D(),J()))}));var C=function(e){var t=e.sort((function(e,t){return e.x>t.x?1:-1})),n=t.slice(0,2),r=t.slice(2,4),a=n.sort((function(e,t){return e.y>t.y?1:-1})),o=a[0],l=a[1],i=r.sort((function(e,t){return e.y>t.y?1:-1}));return[i[0],o,l,i[1]]},F=function(e){for(var t={x:0,y:0},n=0;n<e.length;n++)t.x+=e[n].x,t.y+=e[n].y;return t.x/=e.length,t.y/=e.length,t};function B(e){if(console.log("corner_mouseclick_handler"),"center_manual"==x)if(L.length<4)alert("Before you can create a grid cell you need to place at least four corner markers first.");else if(E.push(e),4==E.length){E=C(E);var t=F(E);I.push({corners:E,center:t,id:l(),truncated:!1}),console.log("Placed a new grid cell at (",t.x,",",t.y,")"),E=[],D(),J()}}function O(e){d3.select(this).raise(),N.select("#g_element").attr("cursor","grabbing")}function R(e){N.select("#g_element").attr("cursor","default")}function G(e){d3.select(this).attr("cx",e.x=d3.event.x).attr("cy",e.y=d3.event.y);for(var t=0;t<I.length;t++)for(var n=0;n<I[t].corners.length;n++)I[t].corners[n].id==e.id&&(I[t].corners[n]=e,I[t].center=F(I[t].corners));D(),J()}function M(e){this.classList.contains("auxline-startpoint")?d3.select(this.parentNode).select("line").attr("x1",e.x1=d3.event.x).attr("y1",e.y1=d3.event.y):this.classList.contains("auxline-endpoint")&&d3.select(this.parentNode).select("line").attr("x2",e.x2=d3.event.x).attr("y2",e.y2=d3.event.y),d3.select(this).attr("cx",e.cx=d3.event.x).attr("cy",e.cy=d3.event.y),D(),J()}function z(e){return d3.line().curve(d3.curveCatmullRom.alpha(1))(e)}function V(e){for(var t=d3.select(this.parentNode).attr("id"),n=0;n<b.length;n++)b[n].id==t&&(this.classList.contains("auxcurve-startpoint")?(b[n].points[0][0]=d3.event.x,b[n].points[0][1]=d3.event.y):this.classList.contains("auxcurve-middlepoint")?(b[n].points[1][0]=d3.event.x,b[n].points[1][1]=d3.event.y):this.classList.contains("auxcurve-endpoint")&&(b[n].points[2][0]=d3.event.x,b[n].points[2][1]=d3.event.y),d3.select(this.parentNode).select("path").attr("d",z(b[n].points)));d3.select(this).attr("cx",d3.event.x).attr("cy",d3.event.y),D(),J()}var q=function(e){"erase"==x&&(this.classList.contains("corner_marker")?function(e){d3.select(e).on("mousedown.drag",null);for(var t=d3.select(e).attr("id"),n=L.length-1;n>=0;n--)if(L[n].id==t){for(var r=w.length-1;r>=0;r--)w[r].x==L[n].x&&w[r].y==L[n].y&&w.splice(r,1);console.log("Deleting corner "+t),L.splice(n,1)}var a=[];for(n=0;n<I.length;n++)for(r=0;r<I[n].corners.length;r++)I[n].corners[r].id==t&&a.push(n);for(n=a.length-1;n>=0;n--)console.log("Deleting grid cell "+I[n].id+"(it contained deleted point "+t+")"),I.splice(a[n],1)}(this):this.classList.contains("auxline-erase")?function(e){for(var t=d3.select(e.parentNode).attr("id"),n=_.length-1;n>=0;n--)_[n].id==t&&(console.log("Deleting auxline "+t),_.splice(n,1))}(this):this.classList.contains("auxcurve-erase")&&function(e){for(var t=d3.select(e.parentNode).attr("id"),n=b.length-1;n>=0;n--)b[n].id==t&&(console.log("Deleting auxcurve "+t),b.splice(n,1))}(this),D(),J())},H=function(e){if("mark_module_partially_visible"==x){$=e.id;for(var t=0;t<I.length;t++)if(I[t].id==$){var n=I[t].truncated;I[t].truncated=!n}D(),J(),P()}},J=function(){var e=N.select("#g_auxobjects").selectAll(".auxline").data(_,(e=>e.id)),t=e.enter().append("g").attr("id",(function(e){return e.id}));t.append("line").attr("class","auxobj auxline auxline-erase").attr("x1",(function(e){return e.x1})).attr("y1",(function(e){return e.y1})).attr("x2",(function(e){return e.x2})).attr("y2",(function(e){return e.y2})).style("stroke","magenta").style("stroke-opacity",.5).style("stroke-width",1).on("mousedown",q),t.append("circle").attr("class","auxline-startpoint auxline-erase").attr("cx",(function(e){return e.x1})).attr("cy",(function(e){return e.y1})).style("r",1.5).style("fill","magenta").on("mousedown",q).call(d3.drag().on("drag",M)),t.append("circle").attr("class","auxline-endpoint auxline-erase").attr("cx",(function(e){return e.x2})).attr("cy",(function(e){return e.y2})).style("r",1.5).style("fill","magenta").on("mousedown",q).call(d3.drag().on("drag",M)),t.merge(e),e.exit().each((function(){d3.select(this.parentNode).remove()}));var n=N.select("#g_auxobjects").selectAll(".auxcurve").data(b,(e=>e.id)),r=n.enter().append("g").attr("id",(function(e){return e.id}));r.append("path").attr("class","auxobj auxcurve auxcurve-erase").attr("d",(function(e){return z(e.points)})).style("stroke","magenta").style("fill","none").style("stroke-width",1).style("stroke-opacity",.5).on("mousedown",q),r.append("circle").attr("class","auxcurve-startpoint auxcurve-erase").attr("cx",(function(e){return e.points[0][0]})).attr("cy",(function(e){return e.points[0][1]})).style("r",1.5).style("fill","magenta").on("mousedown",q).call(d3.drag().on("drag",V)),r.append("circle").attr("class","auxcurve-middlepoint auxcurve-erase").attr("cx",(function(e){return e.points[1][0]})).attr("cy",(function(e){return e.points[1][1]})).style("r",1.5).style("fill","magenta").on("mousedown",q).call(d3.drag().on("drag",V)),r.append("circle").attr("class","auxcurve-endpoint auxcurve-erase").attr("cx",(function(e){return e.points[2][0]})).attr("cy",(function(e){return e.points[2][1]})).style("r",1.5).style("fill","magenta").on("mousedown",q).call(d3.drag().on("drag",V)),r.merge(n),n.exit().each((function(){d3.select(this.parentNode).remove()})),N.select("#g_corners").selectAll(".corner_marker").data(L).join("circle").attr("class","corner_marker").attr("id",(function(e){return e.id})).attr("cx",(function(e){return e.x})).attr("cy",(function(e){return e.y})).attr("r",2).attr("fill","magenta").on("mousedown.1",q).on("mousedown.2",B).call(d3.drag().on("start",O).on("drag",G).on("end",R)),N.select("#g_pv_modules").selectAll(".pv_module").data(I).join("polygon").attr("class","pv_module").attr("id",(function(e){return e.id})).attr("points",(function(e){return e.corners.map((function(e){return[e.x,e.y].join(",")})).join(" ")})).style("fill",(function(e){return e.truncated?"yellow":"lawngreen"})).style("fill-opacity",.5).style("stroke",(function(e){return e.truncated?"yellow":"lawngreen"})).style("stroke-width",.5).on("mousedown",q).on("click",H),N.select("#g_pv_modules").selectAll(".pv_module_center").data(I).join("circle").attr("class","pv_module_center").attr("cx",(function(e){return e.center.x})).attr("cy",(function(e){return e.center.y})).attr("r",2).attr("fill","black")}}(project_id)}))})();